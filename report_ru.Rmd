---
title: "Уровни тревоги по поводу финансового положения в результате глобальной пандемии COVID-19по различным группам населения в 2021 г."
author: "Денис Усалёв"
language: ru
date: "2022-12-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(stringr)
library(ggplot2)
library(tidyr)
```

#### Описание данных.

Данные были получены из базы Всемирного банка, и доступны в базе [World Bank DataBank](https://databank.worldbank.org/source/global-financial-inclusion).


Описание:


> База данных Глобальной финансовой вовлеченности предоставляет более 800 индикаторов финансовой вовлеченности для всех взрослых и сгруппирована по основным демографическим показателям: пол, возраст, образование, доход и доля городского населения. Индикаторы покрывают данные по более чем 150 странам, и показывают, как люди хранят, занимают деньги, осуществляют платежи и управляют рисками.


Дата последнего обновления данных: 2022-10-24.



#### Цель исследования.

В этом исследовании мы заинтересованы в изучении, как разные группы населения оценивают свое финансовое положение после глобальной пандемии COVID-19. Данные доступны на 2021 год, ключевой год пандемии, когда стали видны большинство серьезных последствий различных мер борьбы с вирусом, предпринятых правительствами стран мира. Мы формулируем несколько гипотез согласно общему шаблону "Существует ли влияние на тревогу людей относительно их финансового положения в разных группах по...", где различные критерии группировки населения выступают в качестве независимой переменной, а уровень тревоги - в качестве зависимой.

Мы принимаем уровень значимости результатов тестов на уровне $\alpha = 0.05$.

В проекте применяются библиотеки dplyr, stringr, ggplot2, tidyr.

#### Загрузка и очистка данных.

```{r}
finincl <- read.csv("finincl.csv", stringsAsFactors = T, na.strings = '..')
str(finincl)
```

Мы видим, что датасет содержит 5 переменных и 7142 наблюдения (строки). Данные представлены в разрезе по странам и уровням группировки выборки. Переменная X2021..YR2021. содержит процент респондентов, которых попросили оценить уровень тревожности в следующей формулировке: испытываете ли вы или продолжаете испытывать серьезные финансовые трудности, вызыванные COVID-19? ("Do you experience or continue to experience severe financial hardship as a result of the disruption caused by COVID-19?"). Три варианта ответов: не беспокоюсь, немного беспокоюсь, беспокоюсь (not worried, somewhat worried, worried). Поскольку варианты "немного беспокоюсь" и "беспокоюсь" означают уровень тревожности, отличный от нуля, мы решили совместить эти варианты в одну группу.

Важно отметить, что числовая переменная в датасете представлена как *отношения* в выборке, а не абсолютные значения. Для того, чтобы проводить тесты goodness-of-fit (тест Хи-квадрат), необходимо перевести их обратно в абсолютные значения.
Для этого необходимо учесть два важных фактора. Во-первых, документ [Survey metodology](https://thedocs.worldbank.org/en/doc/f3ee545aac6879c27f8acb61abc4b6f8-0050062022/original/Findex-2021-Methodology.pdf) (Методология опроса) приводит примерное количество респондентов по всему миру в размере 128 000 человек, а также приводит конкретное число опрошенных по каждой стране раздельно. Поскольку n = 128 000 - это достаточно большой размер выборки, мы можем принять его, не обращая внимания на ошибку округления. Во-вторых, итоговые пропорции в датасете являются *взвешенными* с поправкой как на неравную вероятность выборки, так и на ошибки выборки. Это означает, что для каждой группы можно уверенно предполагать существование равной пропорции 1:1 для обеих групп, что поможет нам восстановить изначальную численность респондентов.

Переменная Series.Name содержит полную формулировку вопроса, поэтому мы можем убрать сам вопрос, и оставить только актуальную часть.
Наша переменная с пропорцией содержит пропущенные значения, которые надо очистить.
Мы также переименовали эту переменную для облегчения дальнейшей работы.

```{r}
finincl <- finincl %>% 
  filter(if_all(.fns = ~ !is.na(.x))) %>% 
  mutate(Series.Short = factor(str_match(Series.Name, "(?<=: ).*$"))) %>% 
  mutate(Pct = X2021..YR2021.)
  droplevels
str(finincl)
```

Общее количество значимых наблюдений снизилось до 3522. Интересно, что в процессе мы лишились части стран. Это объясняется тем, что интерфейс загрузки данных на сайте Всемирного банка позволяет выбрать все страны мира, для которых доступны любые данные базы данных, но выгружаются только выбранные данные для конкретного запроса.
Так выглядят некоторые из наших "укороченных" категорий:

```{r}
head(unique(finincl$Series.Short))
```

Данные закодированы в строковом виде, для каждого уровня тревоги и для нескольких критериев группирования генеральной совокупности:

* доход (бедные, богатые)
* пол (мужской, женский)
* занятость (занятые, безработные)
* образование (начальное или ниже, среднее или выше)
* зона проживания (сельская, городская)
* возраст (15-24, 24+)

Мы не можем получить данные на пересечении всех переменных, потому что по каждой группе данные сгруппированы только по уровню тревоги, поэтому необходимо исследовать каждую группу по отдельности. Пол, образование и занятость выглядят наиболее интересными.

#### Гипотезы

Для каждой группы населения, а именно:

* женщины и мужчины
* люди с разными уровнями образования
* занятые / безработные

не существует статистически значимых различий между уровнем беспокойства относительно их оценки свого финансового положения.

#### Методология

Наши зависимые и независимые переменные номинативные. Мы используем линейчатые диаграммы с накоплением, чтобы графически показать существующую разницу, а также критерий хи-квадрат, чтобы подтвердить или опровергнуть нашу гипотезу аналитически.

#### Женщины и мужчины

Вспомогательная функция обрабатывает наш датафрейм, выделяя необходмые группировки из датасета и удаляя лишние переменные.

Мы используем её, чтобы создать датасет наблюдений, где единственной независимой переменной является пол (женский или мужской). Мы исследуем данные для всего мира без разделения на страны. Они доступны по значению 'World' в переменной Country.Name.

```{r}
make_var_df <- function(dtf, pattern, col_name, levels){
  new_dft <- dtf %>% 
    filter(Series.Short <- str_detect(Series.Short, pattern)) %>% 
    droplevels
  new_dft$Anxiety <- factor(str_extract(new_dft$Series.Short, "^([a-z]+) w", 
                                        group = 1), 
                            levels = c("not", "somewhat", "very"))
  levels(new_dft$Anxiety) <- c("No", "Yes", "Yes")
  new_dft[[col_name]] <- factor(str_extract(new_dft$Series.Short, 
                                            paste0(c("(", pattern, ")"),
                                                   collapse = ''),
                                            group = 1))
  new_dft[c("Country.Name", "Pct", "Anxiety", col_name)]
  new_dft %>% 
    filter(Country.Name == "World") %>% 
    group_by(across(c(all_of(col_name), "Anxiety"))) %>% 
    summarize(Pct = sum(Pct)) %>% 
    ungroup()
}
finincl_sex <- make_var_df(finincl, "male|female", "Sex")
str(finincl_sex)
```

Построим график.

```{r}
ggplot(finincl_sex, aes(x = Sex, y = Pct, fill = Anxiety)) +
  geom_col() +
  ggtitle(label = "Уровень тревоги в разделении по полу, %",
          subtitle = "Источник: Всемирный Банк, 2022\nhttps://databank.worldbank.org/source/global-financial-inclusion") +
  theme(plot.subtitle = element_text(size = 8)) +
  scale_fill_brewer(palette = "OrRd") +
  scale_y_continuous("% респондентов",
                     breaks = seq(0, 100, 25),
                     labels = paste0(seq(0, 100, 25), rep("%", 5))) +
  scale_x_discrete("Пол") +
  scale_fill_discrete("Уровень тревоги")
```

Мы видим некоторые различия в группах: мужчины чуть меньше обеспокоены финансовыми трудностями, чем женщины. Однако эта разница не выражена явно.
Переведем наши данные в "широкую" форму, посчитаем примерное количество респондентов и проведем тест.

```{r}
sex_abs <- finincl_sex %>% 
  select(Anxiety, Sex, Pct) %>% 
  mutate(Pct = Pct * 128000 / 2) %>% 
  pivot_wider(names_from = Anxiety, values_from = Pct) %>% 
  select(2:3)
sex_abs <- as.data.frame(sex_abs)
rownames(sex_abs) <- c('Female', 'Male')
chisq.test(sex_abs)
```

#### Результат

Получившееся значение $p < 0.05$ говорит, что мы можем уверенно отвергнуть нулевую гипотезу и утверждать, что существует значимое различие между уровнями тревоги по полу: **женщины с большей вероятностью испытывают тревогу по поводу своего финансового положения, чем мужчины**.

#### Различия в образовании

Двигаемся дальше к сравнению групп с разными уровнями образования, а именно:

* начальное образование или ниже,
* среднее образование или выше.

Обработка данных проводится так же, как в предыдущем случае.

```{r}
finincl_edu <- make_var_df(finincl, 
                           "primary education or less|secondary education or more", 
                           "Education")
str(finincl_edu)
```

График:

```{r}
ggplot(finincl_edu, aes(x = Education, y = Pct, fill = Anxiety)) +
  geom_col() +
  ggtitle(label = "Уровень тревоги в разделении по образованию, %",
          subtitle = "Источник: Всемирный Банк, 2022\nhttps://databank.worldbank.org/source/global-financial-inclusion") +
  theme(plot.subtitle = element_text(size = 8)) +
  scale_fill_brewer(palette = "OrRd") +
  scale_y_continuous("% респондентов",
                     breaks = seq(0, 100, 25),
                     labels = paste0(seq(0, 100, 25), rep("%", 5))) +
  scale_x_discrete("Образование") +
  scale_fill_discrete("Уровень тревоги")
```

Кажется, что различия еще более выраженные в этой классификации. Проверим наши выводы.

```{r}
edu_abs <- finincl_edu %>% 
  select(Anxiety, Education, Pct) %>% 
  mutate(Pct = Pct * 128000 / 2) %>% 
  pivot_wider(names_from = Anxiety, values_from = Pct) %>% 
  select(2:3)
edu_abs <- as.data.frame(edu_abs)
rownames(edu_abs) <- c('Primary', 'Secondary')
chisq.test(edu_abs)
```

#### Результат

С получившимся значением $p < 0.05$ можно уверенно утверждать, что существует значимая разница между уровнем тревоги относительно своего финансового положения для людей с начальным и ниже уровнями образования и для людей со средним и выше уровнями: **люди с более высокими уровнями образования с меньшей вероятностью испытывают тревогу по поводу своего финансового положения**.

#### Занятость

Последнее сравнение, которое мы хотим сделать - по уровню занятости: занятые и безработные респонденты.
Повторяем обработку данных.

```{r}
finincl_emp <- make_var_df(finincl, 
                           "in labor|out of labor", 
                           "Employment")
str(finincl_emp)
```

Chart:

```{r}
ggplot(finincl_emp, aes(x = Employment, y = Pct, fill = Anxiety)) +
  geom_col() +
  ggtitle(label = "Уровень тревоги в разделении по занятости, %",
          subtitle = "Источник: Всемирный Банк, 2022\nhttps://databank.worldbank.org/source/global-financial-inclusion") +
  theme(plot.subtitle = element_text(size = 8)) +
  scale_fill_brewer(palette = "OrRd") +
  scale_y_continuous("% респондентов",
                     breaks = seq(0, 100, 25),
                     labels = paste0(seq(0, 100, 25), rep("%", 5))) +
  scale_x_discrete("Занятость") +
  scale_fill_discrete("Уровень тревоги")
```

В этом случае кажется, что нет видимых различий между двумя группами. Но размер нашей выборки достаточно большой, что скорее всего даже значимые различия могут быть не видны на графике.

```{r}
emp_abs <- finincl_emp %>% 
  select(Anxiety, Employment, Pct) %>% 
  mutate(Pct = Pct * 128000 / 2) %>% 
  pivot_wider(names_from = Anxiety, values_from = Pct) %>% 
  select(2:3)
emp_abs <- as.data.frame(emp_abs)
rownames(emp_abs) <- c('In labor', 'Out of labor')
chisq.test(emp_abs)
```

#### Результат

Действительно, в этот раз показатель $\chi^2$-статистики значительно ниже, чем в предыдущих двух случаях. Тем не менее, с получившимся значением $p < 0.05$ мы по-прежнему можем с уверенностью отклонить нулевую гипотезу и заявить, что существуют значимые различия между уровнем тревоги для работающих и безработных респондентов: **люди, имеющие работу, с меньшей вероятностью испытывают тревогу, чем безработные**.

#### Заключение

Мы смогли успешно доказать существование значимых различий в уровне тревоги относительно финансового положения по всем исследуемым категориям населения.